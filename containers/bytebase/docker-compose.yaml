services:
  bytebase:
    image: bytebase/bytebase:3.14.0
    container_name: bytebase
    restart: unless-stopped

    # Security hardening: prevents the container from gaining additional privileges
    security_opt:
      - no-new-privileges:true

    # Traefik must be attached to the same user-defined network as the services it proxies
    networks:
      - lobby-network

    expose:
      - "8080"

    command:
      - "--data=/var/opt/bytebase"
      - "--external-url=http://bytebase.${LOBBY_TRAEFIK_DOMAIN:-lobby}.${LOBBY_TRAEFIK_TLD:-local}"

    # Bytebase permanent storage
    volumes:
      - ${LOBBY_DATA_DIR:-./data}/bytebase:/var/opt/bytebase

    labels:
      # ============================================================
      # Traefik Self-Routing
      # ============================================================
      # Enable Traefik routing for this container itself
      - "traefik.enable=true"

      # Router that exposes the Traefik dashboard
      # Example:
      #   http://bytebase.lobby.local
      - "traefik.http.routers.bytebase.rule=Host(`bytebase.${LOBBY_TRAEFIK_DOMAIN:-lobby}.${LOBBY_TRAEFIK_TLD:-local}`)"

      - "traefik.http.routers.bytebase.entrypoints=web"
      - "traefik.http.services.bytebase.loadbalancer.server.port=8080"

      # ============================================================
      # Homepage (GetHomepage) Integration
      # ============================================================
      - "homepage.group=DevOps"
      - "homepage.name=Bytebase"
      - "homepage.icon=https://www.bytebase.com/favicon/favicon.png"
      - "homepage.href=http://bytebase.${LOBBY_TRAEFIK_DOMAIN:-lobby}.${LOBBY_TRAEFIK_TLD:-local}"
      - "homepage.description=Database CI/CD & Schema Management"

networks:
  lobby-network:
    driver: bridge
    # Traefik requires a *user-defined* bridge network.
    # The default Docker "bridge" network does not support:
    #   - Container name based service discovery
    #   - Network-scoped aliases
    #   - Proper Traefik routing
    #
    # Therefore we explicitly define one and allow it to be overridden
    # via environment variables for portability.
    name: ${LOBBY_DOCKER_NETWORK:-lobby-network}
